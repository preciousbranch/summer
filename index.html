<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>夏季課題 確認テスト（単一HTML）</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<style>
  :root{
    --fg:#111;--bg:#fff;--muted:#666;--acc:#0a7;--danger:#c33;--ok:#0a7;--card:#f6f7f8;
    --btn:#111;--btnfg:#fff;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:16px/1.6 -apple-system,system-ui,"Segoe UI",Roboto,"Hiragino Sans","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;}
  header{position:sticky;top:0;background:var(--bg);z-index:20;border-bottom:1px solid #e5e7eb}
  .wrap{max-width:980px;margin:0 auto;padding:12px 16px}
  h1{font-size:20px;margin:6px 0 8px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row > *{margin:4px 0}
  select,button,input[type="checkbox"]{font-size:16px}
  button{background:var(--btn);color:var(--btnfg);border:none;border-radius:10px;padding:10px 14px}
  button.ghost{background:#f0f2f3;color:#111}
  button:disabled{opacity:.5}
  label{font-size:14px;color:#222;display:flex;align-items:center;gap:6px;padding:2px 6px;border-radius:8px;background:#f6f7f8}
  #qcard{background:var(--card);border-radius:16px;padding:14px;margin-top:10px}
  .qhead{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .qidx{font-weight:600}
  .subject{font-size:12px;color:#555}
  .qtext{font-size:18px;margin:10px 0}
  .choices{display:grid;gap:8px}
  .choice{border:1px solid #ddd;border-radius:12px;padding:10px;background:#fff}
  .choice button{all:unset;display:block;width:100%;padding:8px 10px;border-radius:10px;cursor:pointer}
  .choice.correct{border-color:#4ade80}
  .choice.wrong{border-color:#fca5a5}
  .mark{font-weight:700;font-size:18px;margin-left:6px}
  .mark.ok{color:var(--ok)}
  .mark.ng{color:var(--danger)}
  .exp{margin-top:10px;font-size:15px;background:#fff;border-radius:12px;padding:10px;border:1px solid #e5e7eb}
  .controls{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  .muted{color:var(--muted);font-size:12px}
  .imgwrap{display:flex;justify-content:center;margin:10px 0}
  .imgwrap img{max-width:100%;height:auto;border-radius:10px;border:1px solid #e5e7eb}
  details {background:#f7f7f8;border-radius:12px;padding:8px 10px;border:1px solid #e5e7eb;margin-top:10px}
  summary {cursor:pointer;font-weight:600}
  .footer{color:#666;font-size:12px;margin:20px 0 40px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;color:#334155;font-size:12px}
  .tag{padding:2px 8px;border:1px solid #d1d5db;border-radius:999px;font-size:12px;color:#374151;background:#fff}
  .bar{height:8px;border-radius:999px;background:#e5e7eb;overflow:hidden}
  .bar > span{display:block;height:100%;background:linear-gradient(90deg,#34d399,#10b981)}
  @media (min-width:700px){
    .row{gap:12px}
  }
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>夏季課題 確認テスト</h1>
    <div class="row">
      <label><input type="checkbox" id="shuffle"> シャッフル</label>
      <label><input type="checkbox" id="memorize"> 暗記モード（前回×のみ）</label>
      <label><input type="checkbox" id="persist"> スコア保存</label>
      <label><input type="checkbox" id="pwa"> オフライン対応（β）</label>
      <select id="mode">
        <option value="learn">学習モード</option>
        <option value="exam">試験モード</option>
      </select>
      <button id="restart" class="ghost">最初から</button>
      <input type="file" id="csv" accept=".csv,.tsv,text/csv,text/tab-separated-values" style="display:none">
      <button id="importBtn" class="ghost">CSV/TSV読み込み</button>
    </div>
    <div class="row" id="statusRow">
      <span class="pill" id="countInfo"></span>
      <span class="tag" id="scoreInfo">–</span>
      <div style="flex:1"></div>
      <span class="muted">データ定義は本ファイル内 <code>QUESTIONS</code> を編集</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="qcard" hidden>
    <div class="qhead">
      <div><span class="qidx" id="qidx">Q1</span> <span class="subject" id="subject"></span></div>
      <div class="muted"><span id="progress"></span></div>
    </div>
    <div class="qtext" id="qtext"></div>
    <div class="imgwrap" id="imgwrap" hidden><img id="qimg" alt=""></div>
    <div class="choices" id="choices"></div>
    <div class="exp" id="exp"></div>
    <div class="controls">
      <button id="prevBtn" class="ghost">← 前へ</button>
      <div style="flex:1"></div>
      <button id="nextBtn">次へ →</button>
    </div>
  </div>

  <details>
    <summary>CSV/TSV 取り込み（列ヘッダ）</summary>
    <ul>
      <li><code>subject</code>：科目</li>
      <li><code>question</code>：問題文（改行は <code>&lt;br&gt;</code>）</li>
      <li><code>choices</code>：選択肢（<code>｜</code> 区切り）</li>
      <li><code>answer</code>：正解番号（0 始まり）</li>
      <li><code>explanation</code>：解説</li>
      <li><code>image</code>：画像URL（任意）</li>
      <li>テンプレ：このHTMLの下にある <code>CSV_TEMPLATE</code> をコピー、または後述のテンプレCSVを利用</li>
    </ul>
  </details>

  <details>
    <summary>更新方法のメモ（差し替えルール）</summary>
    <ul>
      <li>文言修正：<code>Q[番号]：「旧文」→「新文」</code> の指示でOK（例：<code>Q12：「WHOの健康定義〜」→「WHOの健康の定義〜」</code>）。</li>
      <li>問題の追加/削除：このファイル内の <code>QUESTIONS</code> 配列を編集、またはCSVで読み込み。</li>
      <li>画像付き問題：各項目の <code>image</code> にURLを入れる（GitHub Pagesなら <code>assets/</code> 配下に置かず単一HTML推奨）。</li>
      <li>暗記モード：直近セッションの誤答IDsを保持し、×のみ出題。</li>
      <li>スコア保存：最高点・誤答リストを <code>localStorage</code> に保存（この端末/ブラウザ限定）。</li>
    </ul>
  </details>

  <details>
    <summary>GitHub Pages 公開（main / ルート直下）</summary>
    <ol>
      <li>GitHubの対象リポジトリを開く → <b>Add file</b> → <b>Upload files</b> → 本ファイル <code>index.html</code> をドラッグ＆ドロップ → <b>Commit changes</b>。</li>
      <li>設定：<b>Settings</b> → <b>Pages</b> → <b>Branch</b> を <code>main</code> / <code>/root</code> に設定 → 保存。</li>
      <li>公開URLは <code>https://ユーザー名.github.io/リポジトリ名/</code>（数十秒〜数分で反映）。</li>
    </ol>
  </details>

  <div class="footer">
    出題ソース（例示）: 模範回答集・設問PDFに基づき作成。<br>
    注意：本HTMLにはサンプル問題のみ同梱。完全版はCSVで一括投入してください。
  </div>
</main>

<script>
/* =====================
   データ定義：QUESTIONS
   ※ 完全版はCSV/TSVで一括投入を推奨
   ===================== */
const QUESTIONS = [
  // 国語表現法（接続語）
  {subject:"国語表現法", question:"英語に『敬語の文法』といったものはない。（　）英語にも丁寧な表現はある。最も適切な接続語は？", choices:["しかし","つまり","そして","だから","ただし"], answer:0, explanation:"対立・逆接の関係なので「しかし」が適切。"},
  {subject:"国語表現法", question:"彼のレポートは着眼点が面白い。（　）ものの見方、視点が独特なのだ。最も適切な接続語は？", choices:["しかし","つまり","そして","だから","ただし"], answer:1, explanation:"前文の内容を言い換え・要約するので「つまり」。"},
  {subject:"国語表現法", question:"記者は資料を読み込んでいた。（　）質問も鋭かった。最も適切な接続語は？", choices:["しかし","つまり","そして","だから","ただし"], answer:2, explanation:"並列・添加の「そして」。"},
  {subject:"国語表現法", question:"現存している作品は少ない。（　）寡作だったからなおさら希少だ。最も適切な接続語は？", choices:["しかし","つまり","そして","だから","ただし"], answer:3, explanation:"因果関係なので「だから」。"},
  {subject:"国語表現法", question:"鎮痛剤を処方してもらった。（　）痛みがひどくなければ飲まないように言われた。最も適切な接続語は？", choices:["しかし","つまり","そして","だから","ただし"], answer:4, explanation:"条件・例外を付ける「ただし」。"},

  // 情報リテラシー
  {subject:"情報リテラシー", question:"ファイルとは、PC内の音楽や写真、映像・文書などの（　）の記録物のことである。", choices:["情報","容器","場所","拡張子"], answer:0, explanation:"ファイル＝情報の記録物。"},
  {subject:"情報リテラシー", question:"フォルダとは、さまざまなファイルを保管する（　）のことである。", choices:["情報","入れ物","拡張子","ショートカット"], answer:1, explanation:"フォルダ＝ファイルを保管する入れ物。"},
  {subject:"情報リテラシー", question:"盗用とは、他人の所有物を（　）で使用すること。", choices:["引用","無断","有償","慣例的"], answer:1, explanation:"盗用＝無断使用。"},
  {subject:"情報リテラシー", question:"剽窃とは、他人の作品や論文を盗んで、（　）のものとして発表すること。", choices:["共同","自分","第三者","匿名"], answer:1, explanation:"剽窃＝自分のものとして発表。"},

  // 医療倫理学
  {subject:"医療倫理学", question:"基本六法のうち「罪と罰」を規定するのはどれ？", choices:["民法","刑法","商法","行政法"], answer:1, explanation:"罪と罰→刑法。"},
  {subject:"医療倫理学", question:"基本六法のうち「身分と財産」を規定するのはどれ？", choices:["民法","刑法","労働法","憲法"], answer:0, explanation:"身分と財産→民法。"},
  {subject:"医療倫理学", question:"人が死亡した場合の財産の包括的移転を何という？またその根拠法は？", choices:["遺贈／刑法","相続／民法","供託／商法","遺留分／会社法"], answer:1, explanation:"包括的移転＝相続、根拠は民法。"},

  // 生物学
  {subject:"生物学", question:"2つのアミノ酸が結合する際に脱離する分子は？", choices:["CO2","H2O","NH3","O2"], answer:1, explanation:"縮合で水（H2O）が脱離。"},
  {subject:"生物学", question:"アミノ酸同士の結合名称は？", choices:["グリコシド結合","ペプチド結合","リン酸ジエステル結合","水素結合"], answer:1, explanation:"タンパク質主鎖の結合はペプチド結合。"},
  {subject:"生物学", question:"ヒトの染色体数は？", choices:["23本","44本","46本","92本"], answer:2, explanation:"体細胞は46本（22対+性染色体）。"},
  {subject:"生物学", question:"形態学的に定義された細胞死は？", choices:["オートファジー","アポトーシス","ネクローシス","壊疽"], answer:1, explanation:"プログラム細胞死＝アポトーシス。"},
  {subject:"生物学", question:"セントラルドグマの情報の流れは？", choices:["DNA→タンパク質→RNA","RNA→DNA→タンパク質","DNA→RNA→タンパク質","タンパク質→RNA→DNA"], answer:2, explanation:"DNA→RNA→タンパク質。"},
  {subject:"生物学", question:"DNAを合成する酵素は？", choices:["RNAポリメラーゼ","DNAリガーゼ","DNAポリメラーゼ","逆転写酵素"], answer:2, explanation:"DNA合成＝DNAポリメラーゼ。"},

  // 化学
  {subject:"化学", question:"各元素を構成する最小単位は？", choices:["分子","原子","イオン","核"], answer:1, explanation:"基本粒子集合＝原子。"},
  {subject:"化学", question:"原子核を構成する粒子は？", choices:["電子と陽子","中性子と電子","陽子と中性子","陽子と中性子と電子"], answer:2, explanation:"核＝陽子+中性子。"},
  {subject:"化学", question:"陽子の電荷は？", choices:["正","負","中性","可変"], answer:0, explanation:"陽子＝正電荷。"},
  {subject:"化学", question:"酸素とオゾンのように性質が異なる単体同士の関係は？", choices:["同位体","同素体","同族体","異性体"], answer:1, explanation:"同じ元素の性質違い＝同素体。"},
  {subject:"化学", question:"物質量の基本単位（モル）で 6.02×10^23 を何という？", choices:["ファラデー定数","プランク定数","アボガドロ数","ボルツマン定数"], answer:2, explanation:"1モル＝アボガドロ数。"},
  {subject:"化学", question:"pHで中性はいくつ？", choices:["0","1","7","14"], answer:2, explanation:"中性はpH=7。"},

  // 解剖学・歯の解剖学
  {subject:"解剖学・歯の解剖学", question:"三方向断面の名称の組合せとして正しいのは？", choices:["矢状断・前額断・水平断","冠状断・斜断・縦断","横断・回旋断・冠状断","矢状断・横断・回旋断"], answer:0, explanation:"医用画像で基本の3断面。"},
  {subject:"解剖学・歯の解剖学", question:"乳歯は生後何か月ごろから萌出開始し合計何本？", choices:["3か月・16本","6か月・20本","12か月・20本","6か月・24本"], answer:1, explanation:"およそ6か月開始・全20本。"},
  {subject:"解剖学・歯の解剖学", question:"乳歯の脱落開始・完了の目安は？", choices:["4歳開始・8歳完了","5歳開始・10歳完了","6歳開始・12歳ごろ完了","7歳開始・13歳ごろ完了"], answer:2, explanation:"一般に6〜12歳。"},
  {subject:"解剖学・歯の解剖学", question:"出生時に既に歯があり舌潰瘍を起こす病名は？", choices:["アフタ性口内炎","リガ・フェーデ病","口角炎","手足口病"], answer:1, explanation:"先天歯による潰瘍＝リガ・フェーデ病。"},

  // 生理学
  {subject:"生理学", question:"心臓の興奮伝導で最初のペースメーカーは？", choices:["房室結節","ヒス束","プルキンエ線維","洞房結節"], answer:3, explanation:"最初は洞房結節（SA node）。"},
  {subject:"生理学", question:"損傷部位に凝集・止血に関与する血液成分は？", choices:["赤血球","白血球","血小板","血漿"], answer:2, explanation:"一次止血＝血小板。"},
  {subject:"生理学", question:"外界と血液のガス交換は（　）呼吸，細胞と血液は（　）呼吸。", choices:["外・内","内・外","組織・肺","肺・組織"], answer:0, explanation:"肺＝外呼吸，組織＝内呼吸。"},
  {subject:"生理学", question:"胃の主細胞と壁細胞について正しい組合せは？", choices:["主細胞=塩酸，壁細胞=ペプシノーゲン","主細胞=ペプシノーゲン，壁細胞=塩酸と内因子","主細胞=粘液，壁細胞=ガストリン","主細胞=内因子，壁細胞=粘液"], answer:1, explanation:"主細胞→ペプシノーゲン，壁細胞→HClと内因子。"},
  {subject:"生理学", question:"外分泌腺／内分泌腺に関する説明として正しいのは？", choices:["外分泌=血中へ放出","内分泌=導管から体外へ","内分泌=血中へホルモン放出","両方とも導管から放出"], answer:2, explanation:"内分泌は血中へ，外分泌は導管。"},
  {subject:"生理学", question:"体温で深部温度の主な熱産生臓器トップ2は？", choices:["筋・皮膚","肝・筋","心・皮膚","脳・筋"], answer:1, explanation:"肝臓が最大，次いで骨格筋。"},

  // 組織・発生学
  {subject:"組織・発生学", question:"細胞膜の基本構造は？", choices:["糖脂質一重層","リン脂質二重層＋膜タンパク質","タンパク質三重層","コレステロール単層"], answer:1, explanation:"流動モザイクモデル。"},
  {subject:"組織・発生学", question:"ミトコンドリアの主な役割は？", choices:["タンパク質合成","ATP合成","脂質合成","DNA複製"], answer:1, explanation:"ATP産生の場。"},
  {subject:"組織・発生学", question:"リボソームの主な役割は？", choices:["タンパク質合成","脂質合成","ATP産生","糖新生"], answer:0, explanation:"翻訳装置。"},
  {subject:"組織・発生学", question:"腎糸球体ろ過でタンパク質が『ろ過されない』主理由は？", choices:["電荷のため","大きい分子径のため","濃度差のため","能動輸送のため"], answer:1, explanation:"サイズバリアで大分子は通りにくい。"},
  {subject:"組織・発生学", question:"気道粘膜上皮で代表的なのは？", choices:["重層扁平上皮","移行上皮","多列線毛円柱上皮","単層立方上皮"], answer:2, explanation:"気管〜気管支に多い。"},
  {subject:"組織・発生学", question:"最も一般的な結合組織の主要構成は？", choices:["弾性線維と形質細胞","膠原線維と線維芽細胞","好中球と膠原線維","軟骨基質と軟骨細胞"], answer:1, explanation:"疎性結合組織など。"},
  {subject:"組織・発生学", question:"古い骨を壊し新しい骨を作る現象を何という？", choices:["石灰化","骨化","リモデリング","骨芽"], answer:2, explanation:"骨改造＝リモデリング。"},
  {subject:"組織・発生学", question:"胚葉と派生：骨はどこ由来？", choices:["外胚葉","中胚葉","内胚葉","神経堤"], answer:1, explanation:"骨は中胚葉（頭蓋骨の一部は神経堤由来もあるが一般論）。"},
  {subject:"組織・発生学", question:"胚葉と派生：表皮はどこ由来？", choices:["外胚葉","中胚葉","内胚葉","神経堤"], answer:0, explanation:"表皮・付属器は外胚葉。"},
  {subject:"組織・発生学", question:"胎盤の主な働き（ホルモン以外）として正しいのは？", choices:["胆汁分泌","栄養・ガス交換","造血のみ","デトックスのみ"], answer:1, explanation:"栄養・ガス交換など。"},
  {subject:"組織・発生学", question:"胎盤で産生され妊娠判定に用いられるホルモンは？", choices:["FSH","LH","hCG","プロラクチン"], answer:2, explanation:"尿・血中hCGで判定。"},

  // 歯科予防処置論I
  {subject:"歯科予防処置論I", question:"一次・二次・三次予防の組合せとして正しいのは？", choices:["一次=外科処置、二次=定期処置、三次=健康教育","一次=健康教育、二次=定期的処置、三次=外科処置/固定等","一次=SRP、二次=健康教育、三次=定期検診","一次=PTC、二次=PMTC、三次=禁煙"], answer:1, explanation:"模範の表に準拠。"},
  {subject:"歯科予防処置論I", question:"大唾液腺の組合せとして正しいのは？", choices:["耳下腺・顎下腺・舌下腺","耳下腺・舌腺・硬口蓋腺","顎舌腺・舌腺・口唇腺","翼突腺・顎下腺・舌下腺"], answer:0, explanation:"3大唾液腺。"},
  {subject:"歯科予防処置論I", question:"FDI乳歯記号の範囲は？", choices:["1～8","A～E","I～V","a～e"], answer:1, explanation:"乳歯A〜E，永久歯1〜8。"},
  {subject:"歯科予防処置論I", question:"嚥下5期モデルの順として適切なのは？", choices:["口腔期→口腔準備期→咽頭期→食道期","口腔準備期→口腔期→咽頭期→食道期","咽頭期→食道期→口腔期→口腔準備期","食道期→咽頭期→口腔準備期→口腔期"], answer:1, explanation:"準備→口腔→咽頭→食道。"},
  {subject:"歯科予防処置論I", question:"う蝕の重症度分類のうちC4の説明として正しいのは？", choices:["白斑の初期脱灰","象牙質まで進行","歯髄まで達するが歯冠は残存","歯冠のほとんどが崩壊した状態"], answer:3, explanation:"C4＝歯冠崩壊。"},
  {subject:"歯科予防処置論I", question:"口腔内沈着物で『プラークが石灰化したもの』は？", choices:["ペリクル","マテリアルバ","歯石","舌苔"], answer:2, explanation:"歯石＝プラークの石灰化物。"},
  {subject:"歯科予防処置論I", question:"健康歯肉の記述として最も適切なのは？", choices:["発赤・腫脹・出血","ピンクで引き締まる","付着喪失がある","易出血性で潰瘍形成"], answer:1, explanation:"健康＝淡いピンクで引き締まる。"},
];

/* CSVテンプレ（コピー用） */
const CSV_TEMPLATE = `subject,question,choices,answer,explanation,image
国語表現法,英語に『敬語の文法』はない。（　）英語にも丁寧表現はある。,しかし｜つまり｜そして｜だから｜ただし,0,逆接関係なので「しかし」,
情報リテラシー,ファイルとはPC内の音楽や写真などの（　）の記録物である。,情報｜容器｜場所｜拡張子,0,ファイル＝情報の記録物,
生物学,ヒトの染色体数は？,23本｜44本｜46本｜92本,2,体細胞は46本（22対＋性）,`;

/* ============= ユーティリティ ============= */
const byId = (id)=>document.getElementById(id);
const state = {
  order: [], idx: 0, mode: "learn",
  answered: {}, // qIndex -> {selected, correct}
  wrongIds: new Set(),
  persist:false, memorize:false, shuffle:false,
  swActive:false
};
const STORAGE_KEY="summerQuizProgress_v1";

function shuffleArray(a){
  for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}
  return a;
}
function saveIfNeeded(){
  if(!state.persist) return;
  const best = computeScore().pct;
  const payload = {
    wrong:[...state.wrongIds],
    best,
    timestamp: Date.now()
  };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
}
function loadPersist(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch(e){ return null; }
}

/* ============= 初期化 ============= */
function buildOrder(){
  let indices = QUESTIONS.map((_,i)=>i);
  if(state.memorize){
    const saved = loadPersist();
    const wrong = saved?.wrong ?? [];
    indices = indices.filter(i=>wrong.includes(i));
    if(indices.length===0){
      // 直近×が無ければ全問
      indices = QUESTIONS.map((_,i)=>i);
    }
  }
  if(state.shuffle) shuffleArray(indices);
  state.order = indices;
  state.idx = 0;
}

function computeScore(){
  const total = state.order.length;
  let correct = 0;
  for(const k in state.answered){
    if(state.answered[k]?.correct) correct++;
  }
  const pct = total ? Math.round(100*correct/total) : 0;
  return {correct,total,pct};
}

function renderStatus(){
  const {correct,total,pct} = computeScore();
  byId("countInfo").textContent = `問題数: ${state.order.length} 問`;
  byId("scoreInfo").textContent = (state.mode==="exam")
    ? `スコア: ${correct}/${total}（${pct}%）`
    : `学習モード`;
  byId("progress").textContent = `${state.idx+1}/${state.order.length}`;
}

function renderCard(){
  const qIndex = state.order[state.idx];
  const q = QUESTIONS[qIndex];
  if(!q){ byId("qcard").hidden = true; return; }
  byId("qcard").hidden = false;
  byId("qidx").textContent = `Q${state.idx+1}`;
  byId("subject").textContent = q.subject || "";
  byId("qtext").innerHTML = q.question;
  // 画像
  if(q.image){
    byId("imgwrap").hidden=false;
    const img = byId("qimg");
    img.src = q.image;
    img.alt = q.subject || "image";
  }else{
    byId("imgwrap").hidden=true;
    byId("qimg").removeAttribute("src");
  }
  // 選択肢
  const ctn = byId("choices");
  ctn.innerHTML = "";
  q.choices.forEach((c, i)=>{
    const div = document.createElement("div");
    div.className = "choice";
    const btn = document.createElement("button");
    btn.innerHTML = `${String.fromCharCode(65+i)}. ${c}`;
    btn.addEventListener("click", ()=>selectChoice(i));
    div.appendChild(btn);
    ctn.appendChild(div);
  });
  // 解説
  const ans = state.answered[state.idx];
  if(state.mode==="learn"){
    byId("exp").innerHTML = `解説：${q.explanation || "—"}`;
  }else{
    byId("exp").innerHTML = ans ? `解説：${q.explanation || "—"}` : `解説：—（選択すると表示）`;
  }
  highlightSelection();
  renderStatus();
  byId("prevBtn").disabled = state.idx===0;
  byId("nextBtn").disabled = state.idx>=state.order.length-1;
}

function selectChoice(i){
  const qIndex = state.order[state.idx];
  const q = QUESTIONS[qIndex];
  const correct = (i===q.answer);
  // 記録
  state.answered[state.idx] = {selected:i, correct};
  if(!correct){ state.wrongIds.add(qIndex); } else { state.wrongIds.delete(qIndex); }
  // 表示
  highlightSelection();
  // 解説は常に表示（試験モードでも回答後は表示）
  byId("exp").innerHTML = `解説：${q.explanation || "—"}`;
  saveIfNeeded();
}

function highlightSelection(){
  const ans = state.answered[state.idx];
  const children = [...byId("choices").children];
  children.forEach((div, i)=>{
    div.classList.remove("correct","wrong");
    div.querySelector(".mark")?.remove();
    if(!ans) return;
    const mark = document.createElement("span");
    mark.className = "mark " + (i===QUESTIONS[state.order[state.idx]].answer ? "ok":"ng");
    mark.textContent = (i===QUESTIONS[state.order[state.idx]].answer) ? "◯" : "";
    if(i===ans.selected){
      if(ans.correct){ div.classList.add("correct"); } else { div.classList.add("wrong"); }
    }
    div.appendChild(mark);
  });
  // スコアバー
  const {pct} = computeScore();
  if(!byId("scoreBar")){
    const bar = document.createElement("div"); bar.className="bar"; bar.id="scoreBar";
    const span = document.createElement("span"); span.style.width=pct+"%"; bar.appendChild(span);
    byId("statusRow").appendChild(bar);
  }else{
    byId("scoreBar").firstElementChild.style.width = pct+"%";
  }
}

/* ============= PWA (Blob SW) ============= */
async function ensureSW(active){
  if(!('serviceWorker' in navigator)) return;
  if(active){
    if(state.swActive) return;
    const code = `
      const CACHE='quiz-cache-v1';
      self.addEventListener('install',e=>{
        e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['./'])));
        self.skipWaiting();
      });
      self.addEventListener('activate',e=>self.clients.claim());
      self.addEventListener('fetch',e=>{
        const url=new URL(e.request.url);
        if(url.origin===location.origin){
          e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(res=>{
            const copy=res.clone();
            caches.open(CACHE).then(c=>c.put(e.request,copy));
            return res;
          }).catch(()=>caches.match('./'))));
        }
      });
    `;
    const blob = new Blob([code],{type:'text/javascript'});
    const swUrl = URL.createObjectURL(blob);
    try{
      await navigator.serviceWorker.register(swUrl);
      state.swActive = true;
    }catch(e){ console.warn(e); }
  }else{
    const regs = await navigator.serviceWorker.getRegistrations();
    for(const r of regs){ await r.unregister(); }
    state.swActive = false;
  }
}

/* ============= CSV 取り込み ============= */
function parseCSV(text){
  const isTSV = text.split('\n')[0].includes('\t') || (!text.includes(','));
  const rows = text.split(/\r?\n/).filter(l=>l.trim().length);
  const sep = isTSV ? '\t' : ',';
  const head = rows[0].split(sep).map(s=>s.trim());
  const idx = (name)=> head.indexOf(name);
  const s = idx('subject'), q = idx('question'), c = idx('choices'), a = idx('answer'), e = idx('explanation'), im = idx('image');
  const list = [];
  for(let i=1;i<rows.length;i++){
    const cols = rows[i].split(sep);
    if(!cols[q]) continue;
    const obj = {
      subject: (cols[s]||"").trim(),
      question: (cols[q]||"").trim(),
      choices: (cols[c]||"").split('｜').map(x=>x.trim()).filter(Boolean),
      answer: Number((cols[a]||"0").trim()||0),
      explanation: (cols[e]||"").trim(),
      image: (cols[im]||"").trim() || undefined
    };
    if(obj.choices.length<2) continue;
    list.push(obj);
  }
  return list;
}

/* ============= ナビゲーション ============= */
function next(){ if(state.idx<state.order.length-1){ state.idx++; renderCard(); } }
function prev(){ if(state.idx>0){ state.idx--; renderCard(); } }
function restart(){
  state.answered = {};
  buildOrder();
  renderCard();
}

function init(){
  // UI要素に状態を反映
  const saved = loadPersist();
  if(saved){ state.memorize = true; byId("memorize").checked = true; }
  byId("mode").value = "learn";
  state.mode = "learn";

  buildOrder();
  renderCard();
  // イベント
  byId("nextBtn").onclick = next;
  byId("prevBtn").onclick = prev;
  byId("restart").onclick = restart;
  byId("mode").onchange = (e)=>{ state.mode = e.target.value; renderCard(); };
  byId("shuffle").onchange = (e)=>{ state.shuffle = e.target.checked; restart(); };
  byId("memorize").onchange = (e)=>{ state.memorize = e.target.checked; restart(); };
  byId("persist").onchange = (e)=>{ state.persist = e.target.checked; saveIfNeeded(); };
  byId("pwa").onchange = (e)=>{ ensureSW(e.target.checked); };
  byId("importBtn").onclick = ()=>byId("csv").click();
  byId("csv").addEventListener('change', (ev)=>{
    const file = ev.target.files?.[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const list = parseCSV(String(reader.result));
        if(list.length){
          QUESTIONS.length = 0;
          QUESTIONS.push(...list);
          restart();
          alert(`取込完了：${list.length}問`);
        }else{
          alert('データ行が見つかりません。ヘッダと区切り（, または \\t、choicesは ｜ 区切り）を確認してください。');
        }
      }catch(err){
        alert('読み込みに失敗しました: '+err);
      }
    };
    reader.readAsText(file, 'utf-8');
  });
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
